Object.defineProperty(exports, "__esModule", {
    value: true
});
var _jsxFileName = '/Users/vdesai/Biometrix/FathomMobile/src/containers/kit/KitManagementView.js';

var _react = require('react');

var _react2 = babelHelpers.interopRequireDefault(_react);

var _reactNative = require('react-native');

var _reactNativeElements = require('react-native-elements');

var _reactNativeNetworkInfo = require('react-native-network-info');

var _reactNativeBleManager = require('react-native-ble-manager');

var _reactNativeBleManager2 = babelHelpers.interopRequireDefault(_reactNativeBleManager);

var _reactNativeSwiper = require('react-native-swiper');

var _reactNativeSwiper2 = babelHelpers.interopRequireDefault(_reactNativeSwiper);

var _reactNativeModalDropdown = require('react-native-modal-dropdown');

var _reactNativeModalDropdown2 = babelHelpers.interopRequireDefault(_reactNativeModalDropdown);

var _reactNativeCollapsible = require('react-native-collapsible');

var _reactNativeCollapsible2 = babelHelpers.interopRequireDefault(_reactNativeCollapsible);

var _reactNativePrompt = require('react-native-prompt');

var _reactNativePrompt2 = babelHelpers.interopRequireDefault(_reactNativePrompt);

var _theme = require('@theme/');

var _ui = require('@ui/');

var accessoryDiscoverabilityInstruction = 'hold the top and bottom buttons simultaneously until the kit lights flash red and blue';

var KitManagementView = function (_Component) {
    babelHelpers.inherits(KitManagementView, _Component);

    function KitManagementView(props) {
        babelHelpers.classCallCheck(this, KitManagementView);

        var _this = babelHelpers.possibleConstructorReturn(this, (KitManagementView.__proto__ || Object.getPrototypeOf(KitManagementView)).call(this, props));

        _this.componentDidMount = function () {
            _reactNativeNetworkInfo.NetworkInfo.getSSID(function (ssid) {
                _this.setState({ SSID: ssid });
            });

            _reactNativeBleManager2.default.checkState();
            _this.handleDiscoverPeripheral = _this.handleDiscoverPeripheral.bind(_this);
            _this.handleBleStateChange = _this.handleBleStateChange.bind(_this);

            _reactNative.NativeAppEventEmitter.addListener('BleManagerDiscoverPeripheral', function (data) {
                _this.handleDiscoverPeripheral(data);
            });
            _reactNative.NativeAppEventEmitter.addListener('BleManagerDidUpdateState', function (data) {
                _this.handleBleStateChange(data);
            });
            _reactNative.NativeAppEventEmitter.addListener('BleManagerStopScan', function () {
                _this.setState({ scanning: false, resultMsg: { success: 'Finished scanning' } });
            });
        };

        _this.componentWillUnmount = function () {
            _reactNative.NativeAppEventEmitter.removeListener('BleManagerDiscoverPeripheral');
            _reactNative.NativeAppEventEmitter.removeListener('BleManagerDidUpdateState');
            _reactNative.NativeAppEventEmitter.removeListener('BleManagerStopScan');
        };

        _this.turnOnBluetooth = function () {
            _reactNativeBleManager2.default.start({ showAlert: true });

            if (_reactNative.Platform.OS === 'android' && _reactNative.Platform.Version >= 23) {
                _reactNative.PermissionsAndroid.check(_reactNative.PermissionsAndroid.PERMISSIONS.ACCESS_COARSE_LOCATION).then(function (result) {
                    if (!result) {
                        return _reactNative.PermissionsAndroid.request(_reactNative.PermissionsAndroid.PERMISSIONS.ACCESS_COARSE_LOCATION).then(function (res) {
                            if (res === 'denied') {
                                return _this.setState({ resultMsg: { error: 'Bluetooth inactive' } });
                            }
                            return null;
                        });
                    }
                    return _reactNativeBleManager2.default.enableBluetooth().catch(function (error) {
                        return _this.setState({ resultMsg: { error: 'Bluetooth inactive' } });
                    });
                });
            }
        };

        _this.handleScan = function () {
            return _reactNativeBleManager2.default.scan([], 30, false).then(function () {
                _this.refs.swiper.scrollBy(1);_this.setState({ scanning: true, resultMsg: { status: 'Scanning..' }, devicesFound: [] });
            }).catch(function (err) {
                return console.log(err);
            });
        };

        _this.toggleScanning = function (bool) {
            if (bool) {
                _this.setState({ scanning: true });
                return _this.handleScan();
            }
            _this.setState({ scanning: false, ble: null });
            return _reactNativeBleManager2.default.stopScan().then(function (res) {
                return _reactNativeBleManager2.default.checkState();
            });
        };

        _this.handleDiscoverPeripheral = function (data) {
            if (data.name && data.name.indexOf('fathom') > -1 && _this.state.devicesFound.every(function (device) {
                return device.id !== data.id;
            })) {
                console.log('Got new ble data', data);
                _this.state.devicesFound.push(data);
                return _this.setState({ ble: data, devicesFound: _this.state.devicesFound });
            }
            return null;
        };

        _this.handleBleStateChange = function (data) {
            if (data.state === 'off') {
                if (_this.refs.swiper.state.index > 1) {
                    _this.refs.swiper.scrollBy(-_this.refs.swiper.state.index + 1);
                }
                return _this.setState({ resultMsg: { error: 'Bluetooth inactive' } });
            }
            if (_this.refs.swiper.state.index === 1) {
                _this.turnOnBluetooth();
                _this.refs.swiper.scrollBy(1);
            }
            return _this.setState({ resultMsg: { error: null } });
        };

        _this.setSSID = function (ssid) {
            var dataArray = new Array(20);
            dataArray[0] = parseInt('0x04', 16);
            dataArray[1] = ssid.length;
            for (var i = 2; i < 20 && i - 2 < ssid.length; i++) {
                dataArray[i] = ssid.charCodeAt(i - 2);
            }
            for (var _i = ssid.length + 2; _i < 20; _i++) {
                dataArray[_i] = parseInt('0x00', 16);
            }
            console.log('SSID Data Array: ', dataArray);
            return _reactNativeBleManager2.default.write(_this.state.data.id, '3282ae19-ab8b-f495-7544-67e11bb6223f', 'a268ae6f-3433-d999-4e44-42e82070d3de', dataArray).then(function () {
                if (ssid.length <= 18) {
                    return;
                }
                var dataArray = new Array(20);
                dataArray[0] = parseInt('0x05', 16);
                dataArray[1] = ssid.length - 18;
                for (var _i2 = 2; _i2 - 2 < ssid.length - 18; _i2++) {
                    dataArray[_i2] = ssid.charCodeAt(_i2 + 16);
                }
                for (var _i3 = ssid.length - 16; _i3 < 20; _i3++) {
                    dataArray[_i3] = parseInt('0x00', 16);
                }
                console.log('SSID Data Array 2: ', dataArray);
                return _reactNativeBleManager2.default.write(_this.state.data.id, '3282ae19-ab8b-f495-7544-67e11bb6223f', 'a268ae6f-3433-d999-4e44-42e82070d3de', dataArray);
            });
        };

        _this.setWiFiPassword = function (passwordAttempt) {
            var dataArray = new Array(20);
            dataArray[0] = parseInt('0x06', 16);
            dataArray[1] = passwordAttempt.length;
            for (var i = 2; i < 20 && i - 2 < passwordAttempt.length; i++) {
                dataArray[i] = passwordAttempt.charCodeAt(i - 2);
            }
            for (var _i4 = passwordAttempt.length + 2; _i4 < 20; _i4++) {
                dataArray[_i4] = parseInt('0x00', 16);
            }
            console.log('Password Data Array: ', dataArray);
            return _reactNativeBleManager2.default.write(_this.state.data.id, '3282ae19-ab8b-f495-7544-67e11bb6223f', 'a268ae6f-3433-d999-4e44-42e82070d3de', dataArray).then(function () {
                if (passwordAttempt.length <= 18) {
                    return;
                }
                var dataArray = new Array(20);
                dataArray[0] = parseInt('0x07', 16);
                dataArray[1] = passwordAttempt.length - 18;
                for (var _i5 = 2; _i5 - 2 < passwordAttempt.length - 18; _i5++) {
                    dataArray[_i5] = passwordAttempt.charCodeAt(_i5 + 16);
                }
                for (var _i6 = passwordAttempt.length - 16; _i6 < 20; _i6++) {
                    dataArray[_i6] = parseInt('0x00', 16);
                }
                console.log('Password Data Array 2: ', dataArray);
                return _reactNativeBleManager2.default.write(_this.state.data.id, '3282ae19-ab8b-f495-7544-67e11bb6223f', 'a268ae6f-3433-d999-4e44-42e82070d3de', dataArray);
            });
        };

        _this.setupWiFi = function (ssid, password) {
            return _this.setSSID(ssid).then(function () {
                return _this.setWiFiPassword(password);
            }).then(function () {
                var dataArray = new Array(20);
                dataArray[0] = parseInt('0x08', 16);
                dataArray[1] = parseInt('0x00', 16);
                for (var i = 2; i < 20; i++) {
                    dataArray[i] = parseInt('0x00', 16);
                }
                return _reactNativeBleManager2.default.write(_this.state.data.id, '3282ae19-ab8b-f495-7544-67e11bb6223f', 'a268ae6f-3433-d999-4e44-42e82070d3de', dataArray);
            }).then(function () {
                return _reactNativeBleManager2.default.read(_this.state.data.id, '3282ae19-ab8b-f495-7544-67e11bb6223f', 'a268ae6f-3433-d999-4e44-42e82070d3de');
            }).then(function (readData) {
                return console.log(readData);
            }).catch(function (err) {
                console.log(err);_this.setState({ promptVisible: true });
            });
        };

        _this.connect = function (data) {
            return _reactNativeBleManager2.default.connect(data.id).then(function () {
                return _reactNativeBleManager2.default.retrieveServices(data.id);
            }).then(function (peripheralData) {
                return _this.setState({ data: data, promptVisible: true });
            }).catch(function (err) {
                console.log(err);
                return err;
            });
        };

        _this.render = function () {
            return _react2.default.createElement(
                _reactNativeSwiper2.default,
                { ref: 'swiper', scrollEnabled: false, loop: false, __source: {
                        fileName: _jsxFileName,
                        lineNumber: 225
                    }
                },
                _react2.default.createElement(
                    _reactNative.View,
                    { style: [_theme.AppStyles.containerCentered, { flex: 1 }], __source: {
                            fileName: _jsxFileName,
                            lineNumber: 226
                        }
                    },
                    _react2.default.createElement(
                        _reactNative.View,
                        { style: { flex: 1, justifyContent: 'center', alignItems: 'center' }, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 227
                            }
                        },
                        _react2.default.createElement(_reactNative.Image, { style: { resizeMode: 'contain', width: 400, height: 400 }, source: require('@images/Instructions_Kit-Contents-Top_v01.png'), __source: {
                                fileName: _jsxFileName,
                                lineNumber: 228
                            }
                        })
                    ),
                    _react2.default.createElement(
                        _reactNative.View,
                        { style: { flex: 1 }, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 230
                            }
                        },
                        _react2.default.createElement(
                            _ui.FormLabel,
                            { labelStyle: [_theme.AppStyles.h4, { fontWeight: 'bold', color: '#000000' }], __source: {
                                    fileName: _jsxFileName,
                                    lineNumber: 231
                                }
                            },
                            accessoryDiscoverabilityInstruction
                        ),
                        _react2.default.createElement(_ui.Spacer, {
                            __source: {
                                fileName: _jsxFileName,
                                lineNumber: 234
                            }
                        }),
                        _react2.default.createElement(_ui.Button, { title: 'Next', onPress: function onPress() {
                                _this.refs.swiper.scrollBy(1);_reactNativeBleManager2.default.checkState();
                            }, raised: true, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 235
                            }
                        })
                    ),
                    _react2.default.createElement(_reactNative.View, { style: { flex: 1 }, __source: {
                            fileName: _jsxFileName,
                            lineNumber: 237
                        }
                    })
                ),
                _react2.default.createElement(
                    _reactNative.View,
                    { style: [_theme.AppStyles.containerCentered, { flex: 1 }], __source: {
                            fileName: _jsxFileName,
                            lineNumber: 239
                        }
                    },
                    _react2.default.createElement(_reactNative.View, { style: { flex: 1 }, __source: {
                            fileName: _jsxFileName,
                            lineNumber: 240
                        }
                    }),
                    _react2.default.createElement(
                        _reactNative.View,
                        { style: { flex: 1 }, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 241
                            }
                        },
                        _react2.default.createElement(
                            _ui.FormLabel,
                            { labelStyle: [_theme.AppStyles.h4, { fontWeight: 'bold', color: '#000000' }], __source: {
                                    fileName: _jsxFileName,
                                    lineNumber: 242
                                }
                            },
                            'Step 2: Turn on bluetooth'
                        ),
                        _react2.default.createElement(_reactNativeElements.Icon, { name: 'bluetooth', containerStyle: { alignSelf: 'center' }, size: 30, color: _theme.AppColors.brand.primary, reverse: true, onPress: function onPress() {
                                return _this.turnOnBluetooth();
                            }, raised: true, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 243
                            }
                        })
                    ),
                    _react2.default.createElement(_reactNative.View, { style: { flex: 1 }, __source: {
                            fileName: _jsxFileName,
                            lineNumber: 245
                        }
                    })
                ),
                _react2.default.createElement(
                    _reactNative.View,
                    { style: [_theme.AppStyles.containerCentered, { flex: 1 }], __source: {
                            fileName: _jsxFileName,
                            lineNumber: 247
                        }
                    },
                    _react2.default.createElement(_reactNativePrompt2.default, {
                        title: _this.state.SSID + ' Password:',
                        placeholder: 'Password',
                        visible: _this.state.promptVisible,
                        onCancel: function onCancel() {
                            return _this.setState({
                                promptVisible: false
                            });
                        },
                        onSubmit: function onSubmit(value) {
                            _this.setState({ promptVisible: false });
                            return _this.setupWiFi(_this.state.SSID, value);
                        },
                        __source: {
                            fileName: _jsxFileName,
                            lineNumber: 248
                        }
                    }),
                    _react2.default.createElement(_reactNative.View, { style: { flex: 1 }, __source: {
                            fileName: _jsxFileName,
                            lineNumber: 261
                        }
                    }),
                    _react2.default.createElement(
                        _reactNative.View,
                        { style: { flex: 1, alignItems: 'center' }, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 262
                            }
                        },
                        _react2.default.createElement(
                            _ui.FormLabel,
                            { labelStyle: [_theme.AppStyles.h4, { fontWeight: 'bold', color: '#000000' }], __source: {
                                    fileName: _jsxFileName,
                                    lineNumber: 263
                                }
                            },
                            'Step 3: Scan for accessories'
                        ),
                        _react2.default.createElement(_ui.Button, {
                            title: _this.state.scanning ? 'Stop Scan' : 'Start Scan',
                            icon: { name: '' + (_this.state.scanning ? 'stop' : 'play-arrow') },
                            buttonStyle: { backgroundColor: '' + (_this.state.scanning ? _theme.AppColors.red : _theme.AppColors.brand.primary) },
                            onPress: function onPress() {
                                return _this.toggleScanning(!_this.state.scanning);
                            },
                            raised: true,
                            __source: {
                                fileName: _jsxFileName,
                                lineNumber: 264
                            }
                        }),
                        _react2.default.createElement(_ui.Spacer, {
                            __source: {
                                fileName: _jsxFileName,
                                lineNumber: 271
                            }
                        }),
                        _react2.default.createElement(_reactNativeModalDropdown2.default, { options: _this.state.devicesFound.map(function (device) {
                                return device.name;
                            }), onSelect: function onSelect(idx) {
                                return _this.connect(_this.state.devicesFound[idx]);
                            }, __source: {
                                fileName: _jsxFileName,
                                lineNumber: 272
                            }
                        }),
                        _react2.default.createElement(_ui.Spacer, {
                            __source: {
                                fileName: _jsxFileName,
                                lineNumber: 273
                            }
                        }),
                        _react2.default.createElement(
                            _ui.Text,
                            { labelStyle: [_theme.AppStyles.h5, { color: _theme.AppColors.primary }], onPress: function onPress() {
                                    _this.setState({ isCollapsed: !_this.state.isCollapsed });
                                }, __source: {
                                    fileName: _jsxFileName,
                                    lineNumber: 274
                                }
                            },
                            'Can\'t find your device?'
                        ),
                        _react2.default.createElement(_ui.Spacer, {
                            __source: {
                                fileName: _jsxFileName,
                                lineNumber: 275
                            }
                        }),
                        _react2.default.createElement(
                            _reactNativeCollapsible2.default,
                            { collapsed: _this.state.isCollapsed, __source: {
                                    fileName: _jsxFileName,
                                    lineNumber: 276
                                }
                            },
                            _react2.default.createElement(
                                _ui.FormLabel,
                                { labelStyle: [_theme.AppStyles.h4, { fontWeight: 'bold', color: '#000000' }], __source: {
                                        fileName: _jsxFileName,
                                        lineNumber: 277
                                    }
                                },
                                accessoryDiscoverabilityInstruction + '. Then rescan.'
                            )
                        )
                    ),
                    _react2.default.createElement(_reactNative.View, { style: { flex: 1 }, __source: {
                            fileName: _jsxFileName,
                            lineNumber: 282
                        }
                    })
                )
            );
        };

        _this.state = {
            ble: null,
            scanning: false,
            index: 0,
            devicesFound: [],
            isCollapsed: true,
            SSID: null,
            data: null,
            resultMsg: {
                status: null,
                success: null,
                error: null
            }
        };
        return _this;
    }

    return KitManagementView;
}(_react.Component);

KitManagementView.componentName = 'KitManagementView';
KitManagementView.propTypes = {
    user: _react.PropTypes.object
};
KitManagementView.defaultProps = {
    user: {}
};
exports.default = KitManagementView;